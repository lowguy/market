<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
</head>
<body>

</body>
</html>

<script type="text/javascript" src="../script/app.js"></script>
<script type="text/javascript" src="../script/vendor/zepto.js"></script>
<script type="text/javascript" src="../script/model/market.js"></script>
<script type="text/javascript" src="../script/model/user.js"></script>
<script type="text/javascript" src="../script/api/server.js"></script>
<script type="text/javascript">
    var inBackground = false;
    function updateFinished() {
        api.addEventListener({
            name : 'smartupdatefinish'
        }, function(ret, err) {
            openUpdate();
        });
    }

    function login(){
        var userModel = new User();
        var user = userModel.get();
        if(null != user && user.login){
            var server = new Server();
            if(server.cookieNeedUpdate()){
                var url = server.getOne() + '/user/sign/in';
                api.ajax({
                    url:url,
                    cache:false,
                    timeout:10,
                    dataType:'text',
                    returnAll:true,
                    method:"post",
                    data:{
                        values:{
                            phone:user.account,
                            password:user.password,
                            device:api.deviceId,
                            platform:api.systemType == 'ios' ? 1 : 0
                        }
                    }
                },function(ret,err){
                    if(!err && 200 == ret.statusCode){
                        try{
                           var body = JSON.parse(ret.body);
                           console.log(ret.body);
                           if(body.code == 0){
                                 server.setCookie(ret.headers);
                                 user.set(body.data[0],body.data[1], user.account, user.password);
                                 pushAddAlias(user.account);
                           }
                        }catch(e){}
                    }
                });
            }
        }
    }

    function autoLogin(){
        setInterval(login, 30000);
    }

    function afterLocation(lon, lat){
        var market = new Market();
        var map = api.require('xMap');
        map.getNameFromCoords({
                lon : lon,
                lat : lat
        }, function(ret, err) {
            console.log(JSON.stringify(ret));
            if (ret.status) {
                var district = ret.district;
                var city = ret.city;
                market.load(function(){
                    var marketObject = market.getMarket(city, district);
                    if(marketObject){
                        market.setCurrent(marketObject);
                    }
                    else{
                        var districts = market.getMarketsOfCity(city);
                        if(districts.length > 0){
                            market.setCurrent(districts[0]);
                        }
                        else{
                            market.setCurrent(market.markets[0]);
                        }
                    }
                    goHome();
                });
            }
            else{
                console.log(JSON.stringify(err));
                market.load(function(){
                    market.setCurrent(market.markets[0]);
                    goHome();
                });
            }
        });
    }

    function getLocation() {

        var market = new Market();
        var marketObject = market.getCurrent();
        if(!marketObject){
            var map = api.require('xMap');
            map.getLocation({
                accuracy : '10m',
                autoStop : false
            }, function(ret, err) {
                map.stopLocation();
                console.log(JSON.stringify(ret));
                if (ret.status) {
                    afterLocation(ret.lon, ret.lat);
                } else {

                    market.load(function(){
                        market.setCurrent(market.markets[0]);
                        goHome();
                    });
                }
            });
        }
        else{
            goHome();
        }
    }

    function goHome(){
        var postFix = 'ios' == api.systemType ? 'ios' : 'android';
        api.openWin({
            name: 'home',
            url: 'widget://html/home_' + postFix + '.html',
            slidBackEnabled:false,
            animation:{
                type:'none',
                duration:300
            },
            bounces:false,
            reload:false
        });
    }

    function initPush(){
        var push = api.require('ajpush');
        if('ios' != api.systemType){
            push.init();
        }
        else{
            api.addEventListener({name:'noticeclicked'}, function(ret,err) {
                if(ret && ret.value){
                    var content = ret.value.content;
                    var extra = ret.value.extra;
                    dispatchMessage(content, extra);
                }
            });
        }

        api.addEventListener({
            name:'pause'
        },function(ret,err){
            inBackground = true;
            push.onPause();
        });
        api.addEventListener({
            name:'resume'
        },function(ret,err){
            inBackground = false;
            push.onResume();
        });

        push.setListener(
            function(ret){
                if('ios' != api.systemType){
                    ret.extra = JSON.parse(ret.extra);
                    if(inBackground){
                        androidNotifier(ret.content, ret.extra);
                    }
                }
                dispatchMessage(ret.content, ret.extra);
                console.log(JSON.stringify(ret));
            }
        );
        var userModel = new User();
        var user = userModel.get();
        if(user){
            pushAddAlias(user.account);
        }
    }

    function androidNotifier(content, extra){
       api.notification({
           notify:{
               title:'小小家生活助手',
               content:content,
               extra:extra
           }
       },function(ret,err){
       });
    }

    function dispatchMessage(message, extra){
        if(extra){
            switch(parseInt(extra.type)){
                case 1:
                    openDelivery();
                break;
                case 2:
                break;
            }
        }

    }

    function openDelivery(){
        api.openWin({
	        name: 'delivery_home',
	        url: 'widget://html/delivery/home.html',
            slidBackEnabled:false,
	        animation:{
	            type:'none'
	        }
        });
        setTimeout(function(){
            api.execScript({
                name:'delivery_home',
                script: 'newOrder();'
            });
        }, 1000);

    }

    apiready = function () {
        getLocation();
        updateFinished();
        autoLogin();
        initPush();
       
    }


</script>