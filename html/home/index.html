<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
        <link rel="stylesheet" type="text/css" href="../../css/base.css"/>
        <link rel="stylesheet" type="text/css" href="../../css/layout.css"/>
        <link rel="stylesheet" type="text/css" href="../../css/flexslider.css"/>
        <style>
             header{
                 position:fixed;
                 width:100%;
                 z-index:100;
                 top:0;
                 background-color:transparent;
             }
             
             header.white button{
                 color:#FFFFFF;
             }
             header.white .market{
                 background-color:rgba(0,0,0,0.4);
                 border-radius: 2rem
             }
             header.white .market span{
                 background-image:url('../../image/icons/location-white.png');
             }
             header.white .search{
                 background-image: url('../../image/icons/search-white.png');
             }

             header.white .scanner{
                 background-image: url('../../image/icons/scanner-white.png');
             }

             .header{
                 padding:0.5rem 1rem;
             }

            .container {
                height:100%;
                display:none;
            }
            .category-icon {
                max-width: 100%;
                border-radius: 1.5rem;
                width: 4rem;
                height: 4rem;
            }
            .recommend {
                overflow: auto;
                font-size:1.2rem;
            }
            .activity-wrapper{
                padding:1rem 0;
                font-size:1.3rem;
                overflow:auto;
                position: relative;
            }
            .activity-wrapper .vertical-divider{
                width:1px;
                background:#EFEFEF;
                height:100%;
                position:absolute;
                left:50%;
                top:0;
            }
            .activity-item{
                width:50%;
                float: left;
            }

            .recommend-title{
                font-size:1.2rem;
                height:3rem;
                line-height:3rem;
                text-indent:1rem;
                color:#808080;
                border-left:0.5rem solid #FFD705;
            }
            .categories {
                overflow: auto;
                font-size: 1.3rem;
                padding:0.5rem 0;
            }
            .categories .four-column {
                padding: 0.5rem 0;
            }
            .banner{
                width:100%;
            }   
            .four-column{
                width:25%;
                float:left;
                overflow: auto;
            }           
            .two-column{
                padding:0 0.5rem;
            }

            .goods {
                text-align:center;
                overflow: auto;
                border-bottom:0.3rem solid #EFEFEF;
            }
            .goods-wrapper{
                width:50%;
                float:left;
                overflow:auto;
                background-color:#EFEFEF;
            }
            .goods .item {
                position: relative;
                margin-bottom:0.2rem;
                background-color:#FFFFFF;
            }
            .goods .goods-wrapper:nth-child(odd) .item{
                margin-right:0.1rem;
            }
            .goods .goods-wrapper:nth-child(even) .item{
                margin-left:0.1rem;
            }
            .item .goods-thumb {
                width:12rem;
                height:12rem;
            }
            .item.not-enough .goods-thumb{
                -webkit-filter:grayscale(100%);
                filter:grayscale(100%);
            }
            .item.not-enough .stock-less{
                font-size:1.2rem;
                font-weight:bold;
                padding-right:1rem;
                color:red;
                line-height:3rem;
            }
            .item .hot{
                position:absolute;
                height:3rem;
                width:3rem;
                background-image: url('../../image/icons/product-hot.png');
                background-size:contain;
                background-repeat:no-repeat;
                z-index:1;
            }

            .item .discount{
                position:absolute;
                height:3rem;
                width:3rem;
                background-image: url('../../image/icons/product-discount.png');
                background-size:contain;
                background-repeat:no-repeat;
                z-index:1;
            }
            .item .title {
                height: 1.5rem;
                font-size: 1.3rem;
                line-height: 1.5rem;
                font-weight:normal;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                padding:0 1rem;
            }
            .item .advertisement{
                height: 1.4rem;
                font-size: 1.2rem;
                line-height: 1.4rem;
                color:red;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                padding:0 1rem;

            }
            .item .bottom {
                width: 100%;
                height:3rem;
                position: relative;
                font-weight: bold;
                padding-bottom:0.5rem;
            }
            .bottom .price-sales{
                position:absolute;
                height:3rem;
                line-height:1.5rem;
                left:1rem;
                font-family: Helvetica;
                color:red;
                font-weight:bold;
                text-align:left;
            }
            .price-sales .money-symbol{
                font-size:1.5rem;
            }
            .money-symbol.origin{
                font-size:1rem;
                text-decoration: line-through;
                color:#808080;
                font-weight:normal;
            }
            .bottom .sales{
                color:#808080;
                font-weight:normal;
                font-size:1rem;
            }
            .bottom .sales:before{
                content:'已售'
            }
            .bottom .operation {
                text-align: right;
                position:absolute;
                right:0;
                display: inline-block;
                height:3rem;
            }
            .bottom .add {
                height:3rem;
                padding-right: 1rem;
                display: inline-block;
            }
            .bottom .icon {
                height: 2.5rem;
                width: 2.5rem;
                background-size: 1.5rem;
                background-position: 50%;
                border: 1px solid #EFEFEF;
                display: inline-block;
                border-radius: 100%;
                background-repeat: no-repeat;
                margin-top:0.15rem;
            }
            .bottom .add .icon {
                background-image: url("../../image/icons/add.png");
            }

            .bottom .sub {
                height:3rem;
                padding-left: 1rem;
                display: inline-block;
                visibility: hidden;
            }
            .bottom .sub.show {
                visibility: visible;
            }
            .bottom .sub .icon {
                background-image: url("../../image/icons/sub.png");
            }
            .bottom .number {
                visibility: hidden;
                display:inline-block;
                width:1.8rem;
                height:3rem;
                line-height:3rem;
                color:#808080;
                font-size:1.2rem;
                text-align: center;
                text-overflow: ellipsis;
                word-wrap: normal;
                overflow: hidden;
                vertical-align:top;
            }       
            .bottom .number.show {
                visibility: visible;
            }
            
            #banners{
                position:relative;
                overflow:hidden;
                z-index:1;
            }
        </style>
    </head>
    <body>
        <header class="white">
            <section class="header">
                <button tapmode="touch-down" class="scanner">扫一扫</button>
                <button tapmode="touch-down" class="market"><span>定位...</span></button>
                <button tapmode="touch-down" class="search">搜一搜</button>
            </section>
        </header>
        <section id="banners">
            <div class="flexslider">
              <ul class="slides">
                <li>
                  <img src="../../image/banners/home/1.png" />
                </li>
                <li>
                  <img src="../../image/banners/home/2.png" />
                </li>
                <li>
                  <img src="../../image/banners/home/3.png" />
                </li>
                <li>
                  <img src="../../image/banners/home/4.png" />
                </li>
              </ul>
            </div>
        </section>
        <p class="network-error"></p>
        <section class="container">
            <section class="categories text-center">
            </section>
            <section class="divider"></section>
            <section class="recommend-title">
                特惠活动
            </section>
            <section class="divider"></section>
            <section class="activity-wrapper">
                <img tapmode="touch-down" class="activity-item hot" src="../../image/icons/activity-hot.png" data-id="1" />
                <img tapmode="touch-down" class="activity-item daily" src="../../image/icons/activity-daily.png" data-id="2" />
                <p class="vertical-divider"></p>
            </section>
            <section class="divider"></section>
            <section class="recommend-title">
                实时推荐
            </section>
            <section class="divider"></section>
            <section class="recommend clear-all text-center">
            </section>
        </section>
        <script id="categories" type="text/html">
            <%for(var i = 0; i < categories.length; i++){%>
                <section tapmode="touch-down" class="four-column" data-id="<%=categories[i][0]%>">
                    <img 
                        class="category-icon"
                        onload="onCategoryImageLoad(this, <%=categories[i][0]%>, <%=categories[i][2]%>)"
                        <%
                            var selector = '.four-column[data-id="' +  categories[i][0] + '"]';
                            var dom = $(selector).find('img');
                        %>
                        <%if(dom.length){%>
                            src="<%=dom.attr('src')%>"
                        <%}else{%>
                            src="../../image/categories/placeholder.JPG"
                        <%}%>
                    />
                    <p>
                        <%=categories[i][1]%>
                    </p>
                </section>
            <%}%>
        </script>
        <script id="goods" type="text/html">
            <section class="goods">
            <%for(var i = 0; i < goods.length; i++){%>
                <section class="goods-wrapper">
                    <section class="item <%if(!goods[i].status || goods[i].stock < 1){%>not-enough<%}%>" data-id="<%=goods[i].id%>" data-goods="<%=JSON.stringify(goods[i])%>">
                        <%if(1 == goods[i].activity){%>
                            <p class="hot"></p>
                        <%}else if(2 == goods[i].activity){%>
                            <p class="discount"></p>
                        <%}%>
                        <p class="text-center">
                            <img
                                tapmode="touch-down" class="goods-thumb" 
                                onload="onImageLoad(this,<%=goods[i].id%>,<%=goods[i].version%>);"
                                <%
                                    var selector = '.item[data-id="' + goods[i].id + '"]';
                                    var dom = $(selector).find('.goods-thumb');
                                %>
                                <%if(dom.length){%>
                                    src="<%=dom.attr('src');%>"
                                <%}else{%>
                                    src="../../image/products/placeholder.JPG"
                                <%}%>
                             />
                        </p>
                        <p class="title">
                            <span><%=goods[i].title%></span>
                        </p>
                        <p class="advertisement"><%=goods[i].slogan%></p>
                        <section class="bottom text-ellipsis">
                            <p class="price-sales">
                                <span class="money-symbol current"><%=goods[i].price%></span>
                                <br />
                                <%if(0 != goods[i].activity){%>
                                    <span class="money-symbol origin"><%=goods[i].price%></span>
                                <%}%>
                                <span class="sales"><%=goods[i].sales%></span>
                            </p>
                            <p class="operation">
                                <%if(goods[i].status && goods[i].stock > 0){%>
                                <span tapmode="touch-down" class="sub"> 
                                    <span class="icon"></span> 
                                </span>
                                <span class="number">1</span> 
                                <span tapmode="touch-down" class="add"> 
                                    <span class="icon"></span> 
                                </span> 
                                <%}else{%>
                                    <span class="stock-less">补货中...</span>
                                <%}%>
                            </p>
                        </section>
                    </section>
                </section>
            <%}%>
            </section>
        </script>
    </body>
</html>

<script type="text/javascript" src="../../script/app.js"></script>
<script type="text/javascript" src="../../script/window.js"></script>
<script type="text/javascript" src="../../script/frame.js"></script>
<script type="text/javascript" src="../../script/model/market.js"></script>
<script type="text/javascript" src="../../script/model/goods.js"></script>
<script type="text/javascript" src="../../script/model/cart.js"></script>
<script type="text/javascript" src="../../script/vendor/jquery-2.2.4.min.js"></script>
<script type="text/javascript" src="../../script/vendor/jquery.flexslider.js"></script>
<script type="text/javascript" src="../../script/vendor/template.js"></script>
<script type="text/javascript" src="../../script/api/server.js"></script>
<script type="text/javascript">
    var first = true;//标志变量
    var lastUpdated = 0;//数据最后更新时间
    function onImageLoad(dom, id,version){
        loadImage(dom, id, '../../image/products/no.JPG',version);
    }
    function onCategoryImageLoad(dom, id, version){
        dom.onload = null;
        var url = 'http://static.xxj365.com/upload/category/' + id +'.png';
        version = version || 0;
        url += '?version=' + version;

        api.imageCache({
            url: url,
            policy:'cache_only',
            thumbnail:false
        }, function(ret, err){
            if(ret.status){
                dom.src = ret.url;
            }
        });
    }

    function openGoodsDetail(obj){
        var _this = $(obj).parents('.item');
        var goods = $(_this).attr('data-goods');
        goods = JSON.parse(goods);
        api.execScript({
            script: 'openGoodsFrame(' + JSON.stringify(goods) + ')'
        });
	}

    function openMall(obj){
        var id = $(obj).attr('data-id');

        if(id > 0){
            var delay = 0;
            var animation = {
                type:'none',
                duration:300
            };
        
            api.execScript({
                name:'mall',
                script: 'categoryChange(' + id + ');'
            });
            setTimeout(function(){
                pageParam={categoryID:id}
                openWin('mall','mall',animation,delay,pageParam,false);
            }, 100);
        }
    }

    function opacityHeader(percent){
        percent = percent > 1 ? 1 : percent;
        var dom = $('header');
        dom.css('background-color', 'rgba(255,215,5,' + percent +')');
        if(percent < 0.5){
            $('header').addClass('white');
        }
        else{
            $('header').removeClass('white');
        }
    }

    function delegateEvent(){
        $(window).on('scroll', function(){
            var header = $('header');
            var offset = $(window).scrollTop();
            opacityHeader(offset / $('#banners').height());
        });
        touchEvent('.goods-thumb', openGoodsDetail);

        touchEvent('.four-column', openMall);

        touchEvent('.add', addCart);

        touchEvent('.sub', subCart);

        touchEvent('.activity-item', openActivity);

    }
    
    function openActivity(obj){
        var animation = {
            type:'none',
            duration:300
        };

        var delay = 0;
        var id = $(obj).attr('data-id');
 
        api.execScript({
            name:'activity',
            script: 'activityChange(' + id + ');'
        });
        setTimeout(function(){
            pageParam={activityID:id}
            openWin('activity','activity',animation,delay,pageParam,false);
        }, 100);
    }

    function initFront(){

        showNumber();

    }


    function showNumber(){
        $.each($('.goods-wrapper'), function(i, dom){
            var market = new Market();
            var current = market.getCurrent();
            var cart = new Cart();
            var cartGoods = cart.list(current.id);
            var inCart = false;
            var number = 0;
            var _this = $(dom).find('.item');
            var goods = JSON.parse(_this.attr('data-goods'));
            $.each(cartGoods, function(j, item){
                if(goods.id == item.id)
                {
                    inCart = true;
                    number = item.number;
                    return false;
                }               
            });

            if(inCart)
            {
                $(_this).find('.sub').addClass('show');
                $(_this).find('.number').html(number).addClass('show');
            }
            else
            {
                $(_this).find('.sub').removeClass('show');
                $(_this).find('.number').html(number).removeClass('show');
            }
            showPrice(_this, number);

        });
        
    }

    function addCart(obj){
        var marketModel = new Market();
        var current = marketModel.getCurrent();
        var cart = new Cart();
        var goods = JSON.parse($(obj).parents('.item').attr('data-goods'));
        cart.add(current.id, goods.id);
        showNumber();
        api.execScript({
	        script: 'updateCartNumber();'
        });
    }

    function subCart(obj){
        var marketModel = new Market();
        var current = marketModel.getCurrent();
        var cart = new Cart();

        var goods = JSON.parse($(obj).parents('.item').attr('data-goods'));
        cart.sub(current.id, goods.id);
        showNumber();
        api.execScript({
            script: 'updateCartNumber();'
        });
    }

    function showPrice(dom, number){
        var goods = JSON.parse(dom.attr('data-goods'));
        var activity = goods.activity || 0;
        if(0 != activity){
            if(1 == activity){
                if(!dom.hasClass('not-enough')){
                    if(number > 2){
                        dom.find('.money-symbol.current').text(goods.price);
                    }
                    else{
                        dom.find('.money-symbol.current').text(goods.discount);
                    }
                }
                else{
                    dom.find('.money-symbol.current').text(goods.discount);
                }
            }
            else if(2== activity){
                dom.find('.money-symbol.current').text(goods.discount);
            }
        }
    }

    function renderCategory(categories){
        if(categories.length < 4){
            for(var i = categories.length; i < 4; i++){
                categories[i] = [0, '敬请期待', 0]
            }
        }
        else if(categories.length > 4 && categories.length < 8){
            for(var i = categories.length; i < 8; i++){
                categories[i] = [0, '敬请期待', 0]
            }
        }
        var html=baidu.template('categories',{categories:categories});
        $('.categories').html(html);
    }

    function render(ret){
        renderCategory(ret.categories);
        var goodsModel = new Goods();
        var goods = goodsModel.merge(ret.recommend);
        var html=baidu.template('goods',{goods:goods});
        $('.recommend').html(html);
        initFront();
        if('none' == $('.container').css('display'))
        {
            loaded();
            $('.container').fadeIn(300);
        }
        api.parseTapmode();
    }

    function ajaxComplete(){
        api.refreshHeaderLoadDone();
        if(first){
            first = false;
            setTimeout(loaded, 5000);
        }
    }

    function autoLocation(){
        var market = new Market();
        var current = market.getCurrent();
        if(0 == current.auto){
            return;
        }
        var map = api.require('xMap');
        map.getLocation({
            accuracy : '10m',
            autoStop : false
        }, function(ret, err) {
            map.stopLocation();
            if (ret.status) {
                map.getNameFromCoords({
                lon : ret.lon,
                lat : ret.lat
                }, function(ret, err) {
                    if (ret.status) {
                        var district = ret.district;
                        var city = ret.city;
                        market.load(function() {
                            var marketObject = market.getMarket(city, district);
                            if (marketObject) {
                                market.setCurrent(marketObject);
                                if(marketObject.id != current.id){
                                    marketChange();
                                    api.toast({
                                        msg:'小小家服务站点自动切换...',
                                        location:'middle',
                                        global:true
                                    });
                                }
                            } else {
                                var districts = market.getMarketsOfCity(city);
                                if (districts.length > 0) {
                                    market.setCurrent(districts[0]);
                                    marketChange();
                                    api.toast({
                                        msg:'小小家服务站点自动切换...',
                                        location:'middle',
                                        global:true
                                    });
                                } else {
                                    market.setCurrent(current);
                                }
                            }
                        });
                    }
                });
            }
        });
    }

    function request(){
        api.cancelAjax({tag: 'home_ajax'});
        var market = new Market();      
        var current = market.getCurrent();
        var server = new Server();
        var url = server.getOne() + "/customer/home/index?id=" + current.id;

        api.ajax({
            url:url,
            cache:true,
            timeout:5,
            dataType:'text',
            returnAll:true,
            tag:'home_ajax'
        },function(ret,err){
            ajaxComplete();
            if(!err && 200 == ret.statusCode){
                try{
                    var body = JSON.parse(ret.body);
                    render(body.data);
                    lastUpdated = timestamp();
                }catch(e){}
            }
        });
    }

    function scrollBanner(){
        $('#banners').height(api.winWidth * 5 / 12);
        var slider = null;
        $('.flexslider').flexslider({
            animation: "fade",
            animationLoop: true,
            itemWidth: api.winWidth,
            itemMargin: 0,
            directionNav: false,
            slideshowSpeed:5000,
            animationSpeed: 1000,
            slideshow:true,
            after:function(slider){
                if(slider && !slider.playing){
                    slider.play();
                }
            },
            init:function(obj){
                slider = obj;
            }
        });
        $('.flexslider').on('touchend', function(){
            if(slider && !slider.playing){
                slider.play();
            }
        });
    }
    apiready = function() {
        scrollBanner();
        loading();
        initNavigator();

        onMarketChange(function(){
            var market = new Market();
            var current = market.getCurrent();
            $('header .market span').html(current.district);
            request();
        });

        autoLocation();
        delegateEvent();

        request();

        onNetworkChanged(request, function(){
            var now = timestamp();
            if(now - lastUpdated > 10){
                request();
            }
        });

        api.addEventListener({
            name:'viewappear'
        },function(ret,err){
            showNumber();
        });

        api.addEventListener({
            name:'resume'
        },function(ret,err){
            var now = timestamp();
            if(now - lastUpdated > 600){
                setTimeout(function(){
                    request();
                }, 200);
            }
        });
    }
</script>